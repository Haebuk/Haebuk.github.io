---
layout: single
title: "[Kubernetes] 워크로드 API 정리"
categories: Kubernetes # 카테고리
tag: [Kubernetes, 워크로드API]
toc: true # 오른쪽에 table of contents 를 보여줌
author_profile: true # 게시글 들어갔을 때 좌측에 프로필 가리기
--- 

# 워크로드 API 카테고리
- 클러스터에 컨테이너를 기동시키기 위해 사용되는 리소스
  - Pod
  - Replication Controller(Deprecated)
  - ReplicaSet
  - Deployment
  - DemonSet
  - StatefulSet
  - Job
  - CronJob


## 파드
- 워크로드 리소스의 최소 단위


### 파드 디자인 패턴
| 종류          | 개요                             |
| ------------- | -------------------------------- |
| 사이드카 패턴 | 메인 컨테이너에 기능 추가        |
| 앰배서더 패턴 | 외부 시스템과의 통신 중계        |
| 어댑터 패턴   | 외부 접속을 위한 인터페이스 제공 |

### 파드 명령어

```shell
# 파드 생성
$ kubectl apply -f sample-pod.yaml
```

```shell
# 파드 목록 표시
$ kubectl get pods
```

```shell
# 파드 상세 정보 표시
$ kubectl get pods --output wide
```

```shell
# 컨테이너에서 /bin/bash 실행
$ kubectl exec -it sample-pod -- /bin/bash
root@sample-pod:/# (이후 컨테이너 내부에서 명령어 실행 가능)

# 컨테이너에서 ls 명령어 실행
$ kubectl exec -it sample-pod -- /bin/ls

# 다수의 컨테이너 포함한 파드의 경우 특정 컨테이너 지정 가능
$ kubectl exec -it sample-2pod -c nginx-container -- /bin/ls
```

### 파드 주의 사항
- 파드 내 컨테이너가 같은 포트로 바인드되면 안됨
- 쿠버네티스는 `ENTRYPOINT`를 `command`, `CMD`를 `args`라고 부름
- 파드명 제한
  - 영어 소문자 또는 숫자
  - 기호는 '-' 또는 '.'
  - 시작과 끝은 영어 소문자

## 레플리카셋/레플레케이션 컨트롤러
- 파드의 레플리카를 생성하고 지정한 파드 수를 유지하는 리소스
- 노드나 파드에 장애가 발생했을 때도 지정한 파드 수를 유지하기 위해 다른 노드에서 파드를 기동하므로 장애 시에 많은 영향 받지 않음
- 모니터링은 특정 레이블을 가진 파드 수를 계산하는 형태로 이루어짐

### 레플리카셋 명령어
```shell
# 레플리카셋 생성
$ kubectl apply -f sample-rs.yaml

# 레플리카셋 확인
$ kubectl get replicasets -o wide
```
```shell
# 레이블 지정하여 파드 목록 표시
# 레플리카셋 이름-임의의 문자열로 명명 ex. sample-rs-cnvm5
kubectl get pods -l app=sample-app -o wide
```
```shell
# 레플리카셋 상세 정보 표시 (증감 이력 등)
# kubectl describe replicaset sample-rs
```

### 레플리카셋 주의점
- spec.selector와 spec.template.metadata.labels의 레이블의 일치하지 않으면 에러
- 외부에서 같은 레이블을 가진 파드가 있으면 레플리카 수에 충족되는 만큼 파드 삭제

### 레플리카셋 스케일링
- 두 가지 방법
  - 매니페스트 수정하여 `kubectl apply -f` 명령어 실행
    - IaC(Infrastructure as Code)를 구현하기 위해서라도 해당 방법 권장
    ```shell
    $ sed -i -e 's|replicas: 3|replicas: 4|' sample-rs.yaml
    $ kubectl apply -f sample-rs.yaml
    ```
  - `kubectl scale` 명령어를 사용하여 스케일 처리
    - 레플리카셋 이외에도 디플로이먼트/스테이트풀셋/잡/크론잡에서 사용 가능
    ```shell
    # 레플리카 수를 5로 변경
    $ kubectl scale replicaset sample-rs --replicas 5 
    ```

## 디플로이먼트
- 여러 레플리카셋을 관리하며 롤링 업데이트나 롤백 등을 구현하는 리소스
- 디플로이먼트 -> 레플리카셋 -> 파드 (관리 순서)
- 롤링 업데이트 과정
  1. 신규 레플리카셋 생성
  2. 신규 레플리카셋 레플리카 수(파드 수)를 단계적으로 늘림
  3. 이전 레플리카셋의 레플리카 수(파드 수)를 단계적으로 줄임
  4. 2,3 반복
  5. 이전 레플리카셋은 레플리카 수를 0으로 유지
- 파드를 하나만 기동해도 디플로이먼트 사용을 권장(파드 장애시 자동 재생성, 롤링 업데이트 등)

### 디플로이먼트 명령어
```shell
# --record를 사용하여 업데이트 이력을 저장. 디플로이먼트 가동 (deprecated option)
$ kubectl apply -f sample-deployment.yaml --record
```
```shell
# 디플로이먼트 확인
$ kubectl get deployments
NAME                READY   UP-TO-DATE   AVAILABLE   AGE
sample-deployment   3/3     3            3           2m30s

# 레플리카셋 확인
$ kubectl get replicasets
NAME                           DESIRED   CURRENT   READY   AGE
sample-deployment-77c7b569f6   3         3         3       2m39s

# 파드 확인
$ kubectl get pods
NAME                                 READY   STATUS    RESTARTS   AGE
sample-deployment-77c7b569f6-bnbcw   1/1     Running   0          2m44s
sample-deployment-77c7b569f6-fzh2m   1/1     Running   0          2m44s
sample-deployment-77c7b569f6-wjvbn   1/1     Running   0          2m44s
```
```shell
# 컨테이너 이미지 업데이트
$ kubectl set image deployment sample-deployment nginx-container=nginx:1.17 --record

# 디플로이먼트 업데이트 상태 확인
$ kubectl rollout status deployment sample-deployment

# 변경 이력 확인
$ kubectl rollout history deployment sample-deployment

# 초기 상태의 디플로이먼트
$ kubectl rollout history deployment sample-deployment --revision 1

# 한 번 업데이트된 후의 디플로이먼트
$ kubectl rollout history deployment sample-deployment --revision 2

# 버전 지정하여 롤백
$ kubectl rollout undo deployment sample-deployment --to-revision 1

# 직전 버전으로 롤백
$ kubectl rollout undo deployment sample-deployment
```

```shell
# 업데이트 일시 정지
$ kubectl rollout pause deployment sample-deployment

# 업데이트 일시 정지 해제
$ kubectl rollout resume deployment sample-deployment
```
```shell
# 레플리카 수를 3에서 4로 변경한 매니페스트를 apply - 디플로이먼트 스케일링
$ sed -i -e 's|replicas: 3|replicas: 4|' sample-deployment.yaml
$ kubectl apply -f sample-deployment.yaml

# kubectl scale 명령어
$ kubectl scale deployment sample-deployment --replicas=5
```
```shell
# 매니페스트를 사용하지 않고 명령어로 디플로이먼트 생성
$ kubectl create deployment sample-deployment-by-cli --image nginx:1.16
```

### 디플로이먼트 업데이트 전략

#### Recreate
- 모든 파드 삭제하고 다시 파드 생성
- 다운타임 발생하지만 추가 리소스를 사용하지 않으며 전환이 빠름
  - 기존 레플리카셋의 레플리카 수를 0으로 하고 리소스 반환
  - 신규 레플리카셋 생성하고 레플리카 수 늘림

#### RollingUpdate
- 업데이트 중 정지 가능 최대 파드 수(maxUnavailable)와 생성 가능한 최대 파드 수(maxSurge)를 설정 가능
- 추가 리소스를 사용하지 않도록 하거나 많은 리소스를 소비하지 않고 빠르게 전환하는 등의 동작 제어 가능
- maxUnavailable과 maxSurge 모두 0은 불가능

#### 상세 업데이트 파라미터
- minReadySeconds(최소 대기 시간(초))
  - 파드가 Ready 상태가 된 후 디플로이먼트 리소스에서 파드 기동이 완료되었다고 판단(다음 파드의 교체가 가능하다고 판단)하기까지의 최소 시간
- revisionHistoryLimit(수정 버전 기록 제한)
  - 디플로이먼트가 유지할 레플리카셋 수
  - 롤백이 가능한 이력 수
- progressDeadlineSeconds(진행 기한 시간(초))
  - Recreate/RollingUpdate 처리 타임아웃 시간
  - 타임아웃 시간 경과시 자동 롤백

### 디플로이먼트 주의사항
- 실제 환경에서는 롤백 보다는 이전 매니테스트를 `kubectl apply`를 실행하여 적용하는 것이 호환성 면에서 좋음
- pause 상태에서는 업데이트가 즉시 반영되지 않고, 롤백도 되지 않음